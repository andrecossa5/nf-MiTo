# TUNE - EXPLORE - INFER tutorial

nf-MiTo INFER entrypoint (see [INFER tutorial](2.INFER.md)) performs all the operations (e.g., AFM pre-processing, character matrix bootstrapping and tree and clonal inference) required for lineage inference.

However, a single-combination of parameters only returns a *single* phylogeny. To make sure that our biological conclusion are robust to this parameter choice, it might be useful to perturb these parameters and explore different character spaces (with their associated phylogenies). Ideally, this *tuning* phase should be fast enough to lead to the "optimal" parameter combination. Visualization of cell phylogenies could also help this choice.

To facilitate all of these operations, nf-MiTo implements 3 composable workflows: TUNE, EXPLORE, and INFER. 

Here, we will demonstrate how to explore alternative MT-SNVs spaces using data from the `MDA_clones` sample (see [INFER tutorial](2.INFER.md)).

The whole analysis should take ~45 minutes (on an HPC environment).

# Prerequisites

These downstream workflows are not particularly memory intensive (i.e., a modern laptop with 16GB RAM and 8 cpus can handle all processes). However, being on a HPC computing cluster can significantly speed up all parallel operations (e.g., character matrices bootstrapping, distance calculations and tree inference), with multiple processes executed simoultaneously. 
As mentioned in the other tutorials, our only requirements include one between docker/apptainer/singularity in our $PATH, together with Nextflow.
We can check their availability with:

```bash
apptainer 
nextflow
```

# Download data

We start by downloding test data from zenodo. This includes the AFM and associated cell metadata
from a run of nf-MiTo PREPROCESS entrypoint (default options):

```bash
wget https://zenodo.org/records/17209529/files/data_test.tar.gz
```

# Prep data

Untar test_data:

```bash
tar -xzf data_test.tar.gz
```

Our `data_test` folder should look like:

```
data_test
├── afm_unfiltered.h5ad
└── cells_meta.csv
```

We have downloaded our test dataset. We are now ready to prep our `afm_input` file.

# Prep input file

We prep our <span style="white-space: nowrap;">`--afm_input`</span> CSV file following this template:

<table>
<thead>
<tr>
<th align="left">job_id</th>
<th align="left">sample</th>
<th align="left">afm</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left"><code>test_0.1</code></td>
<td align="left"><code>MDA_clones<code></td>
<td align="left"><code>path to AFM</code></td>
</tr>
</tbody>
</table>

# TUNE 

We will start with the TUNE entrypoint. This workflow parallelize all lineage inference operations (i.e., cell and MT-SNVs filtering, genotyping, distance calculations, phylogeny and clonal inference) across the chosen parameter combinations, *without* bootstrapping character matrices (the most computationally heavy part of the INFER workflow). To accomplish this, we need to prep our `user_params.json` file with both
I/O and AFM pre-processing parameters.

```json
{  
    "afm_input" : "<path to --afm_input .csv file>",
    "output_folder" : "<path to output folder>",
    "path_meta" : "<path to cells metadata .csv file>", 
    "lineage_column" : "GBC",
    "min_n_positive" : [5],
    "af_confident_detection": [0.02, 0.03, 0.04],
    "min_n_confidently_detected": [2,5],
    "min_mean_AD_in_positives": [1,1.25,1.5],
    "t_prob": [0.7],
    "min_AD": [1,2],
    "min_cell_prevalence": [0.1],
    "bin_method": ["MiTo"]
}
```

Note that, for the TUNE entrypoint, the AFM preprocessing options `--af_confident_detection`, `--min_mean_AD_in_positives`, `--min_mean_AD_in_positives`, `--t_prob`, `--min_AD`, `--min_cell_prevalence`, `--bin_method` **must** be passed as arrays (even single-valued arrays). This is necessary to combine these options for Grid Search (i.e., all alternative combinations of parameters will be tested). Moreover, for this dataset we specified for the `lineage_column` option. This will allow nf-MiTo to properly recognize the `GBC` column in cell metadata as ground truth clonal labels. In turn, this parameter choice will include, among the other lineage inference evaluation metrics:

1. The Adjusted Rand Index (ARI) between MiTo clones and GBC (lentiviral clones) labels
2. The Normalized Mutual Information (NMI) between MiTo clones and GBC (lentiviral clones) labels
3. The % of MT-SNVs that is significantly enriched in a ground truth clone

Once `user.config` are set (see [PREPROCESS tutorial](1.PREPROCESS.md)), we can launch `nf-MiTo` TUNE:

```bash
nextflow run main.nf -profile docker,local -params-file user_params.json -entry TUNE
```

After a successfull run, the output folder `<path to output folder>` should contains all the following outputs:

```
TUNE
├── all_metrics_final.csv
└── all_options_final.csv
```







